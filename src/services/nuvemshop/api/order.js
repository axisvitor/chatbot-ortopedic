const { NuvemshopApiBase } = require('./base');
const { NUVEMSHOP_CONFIG } = require('../../../config/settings');
const { CacheService } = require('../../../services/cache-service');

class OrderApi extends NuvemshopApiBase {
    constructor(client = null) {
        const cacheService = new CacheService();
        super(client, cacheService);
        
        this.cachePrefix = NUVEMSHOP_CONFIG.cache.prefix + 'order:';
        this.defaultFields = [
            'id',
            'number',
            'status',
            'payment_status',
            'shipping_status',
            'customer',
            'products',
            'shipping_tracking_number',
            'shipping_tracking_url'
        ].join(',');
    }

    // Valida√ß√µes
    validateOrderId(orderId) {
        // Converte para n√∫mero se for string
        const numericId = typeof orderId === 'string' ? parseInt(orderId, 10) : orderId;
        
        if (!numericId || isNaN(numericId)) {
            throw new Error('ID do pedido inv√°lido');
        }
        
        return numericId; // Retorna o ID convertido
    }

    validateOrderNumber(orderNumber) {
        if (!orderNumber || (typeof orderNumber !== 'string' && typeof orderNumber !== 'number')) {
            throw new Error('N√∫mero do pedido inv√°lido');
        }
        return orderNumber.toString(); // Garante que √© string
    }

    validateDateRange(startDate, endDate) {
        if (startDate && !(startDate instanceof Date)) {
            throw new Error('Data inicial inv√°lida');
        }
        if (endDate && !(endDate instanceof Date)) {
            throw new Error('Data final inv√°lida');
        }
        if (startDate && endDate && startDate > endDate) {
            throw new Error('Data inicial n√£o pode ser maior que a data final');
        }
    }

    // M√©todos principais
    async getOrder(orderId) {
        const numericId = this.validateOrderId(orderId);
        
        // Tenta buscar do cache primeiro
        const cacheKey = `${this.cachePrefix}${numericId}`;
        const cachedOrder = await this.cacheService.get(cacheKey);
        if (cachedOrder) {
            console.log('üéØ Pedido encontrado no cache:', {
                id: numericId,
                timestamp: new Date().toISOString()
            });
            return JSON.parse(cachedOrder);
        }

        try {
            console.log('üîç Buscando pedido na Nuvemshop:', {
                id: numericId,
                timestamp: new Date().toISOString()
            });

            const response = await this.client.get(`/orders/${numericId}`, {
                params: {
                    fields: this.defaultFields
                }
            });

            // Salva no cache
            await this.cacheService.set(
                cacheKey, 
                JSON.stringify(response.data),
                NUVEMSHOP_CONFIG.cache.ttl
            );

            return response.data;
        } catch (error) {
            if (error.response?.status === 404) {
                console.log('‚ùå Pedido n√£o encontrado:', {
                    id: numericId,
                    timestamp: new Date().toISOString()
                });
                return null;
            }
            console.error('‚ùå Erro ao buscar pedido:', {
                id: numericId,
                erro: error.message,
                timestamp: new Date().toISOString()
            });
            throw error;
        }
    }

    async getOrderByNumber(orderNumber) {
        this.validateOrderNumber(orderNumber);
        
        // Gera as chaves do cache
        const cacheKey = `${this.cachePrefix}number:${orderNumber}`;
        const idMapKey = `${this.cachePrefix}number_to_id:${orderNumber}`;
        
        // Tenta buscar do cache primeiro
        const cachedOrder = await this.cacheService.get(cacheKey);
        if (cachedOrder) {
            console.log('[Nuvemshop] Pedido encontrado no cache:', {
                numero: orderNumber,
                id: cachedOrder.id,
                status: cachedOrder.status,
                rastreio: cachedOrder.shipping_tracking_number
            });
            return cachedOrder;
        }

        try {
            console.log('üîç Buscando pedido:', {
                numero: orderNumber,
                textoOriginal: orderNumber,
                timestamp: new Date().toISOString()
            });

            // Tenta buscar o ID do pedido do cache
            const orderId = await this.cacheService.get(idMapKey);
            
            if (orderId) {
                console.log('[Nuvemshop] ID do pedido encontrado no cache:', {
                    numero: orderNumber,
                    id: orderId
                });

                try {
                    // Busca direta pelo ID
                    const order = await this.handleRequest('get', `/v1/${NUVEMSHOP_CONFIG.userId}/orders/${orderId}`);
                    
                    if (order && String(order.number) === String(orderNumber)) {
                        // Salva no cache por 5 minutos
                        await this.cacheService.set(cacheKey, order, 300);
                        
                        console.log('[Nuvemshop] Pedido encontrado pelo ID:', {
                            numero: orderNumber,
                            id: order.id,
                            status: order.status,
                            rastreio: order.shipping_tracking_number
                        });
                        
                        return order;
                    } else {
                        // Remove o ID inv√°lido do cache
                        await this.cacheService.delete(idMapKey);
                    }
                } catch (error) {
                    if (error.response?.status === 404) {
                        // Remove o ID inv√°lido do cache
                        await this.cacheService.delete(idMapKey);
                    } else {
                        throw error;
                    }
                }
            }

            // Se n√£o encontrou pelo ID, busca pelo n√∫mero
            const endpoint = `/v1/${NUVEMSHOP_CONFIG.userId}/orders`;
            const response = await this.handleRequest('get', endpoint, {
                params: {
                    q: orderNumber,
                    fields: this.defaultFields
                }
            });

            if (!response) {
                console.log('[Nuvemshop] Pedido n√£o encontrado:', {
                    numero: orderNumber,
                    timestamp: new Date().toISOString()
                });
                return null;
            }

            // Se encontrou pedidos, procura pelo n√∫mero exato
            const order = Array.isArray(response) ? 
                response.find(o => o.number.toString() === orderNumber.toString()) : 
                (response.number.toString() === orderNumber.toString() ? response : null);

            if (order) {
                // Salva o pedido no cache por 5 minutos
                await this.cacheService.set(cacheKey, order, 300);
                
                // Salva o mapeamento n√∫mero -> id por 1 dia
                await this.cacheService.set(idMapKey, order.id, 86400);
                
                console.log('[Nuvemshop] Pedido encontrado e salvo no cache:', {
                    numero: orderNumber,
                    id: order.id,
                    status: order.status,
                    rastreio: order.shipping_tracking_number
                });
                
                return order;
            }

            console.log('[Nuvemshop] Pedido n√£o encontrado:', {
                numero: orderNumber,
                resultados: Array.isArray(response) ? response.length : 0
            });
            
            return null;

        } catch (error) {
            console.error('[Nuvemshop] Erro ao buscar pedido:', {
                numero: orderNumber,
                erro: error.message,
                status: error.response?.status,
                timestamp: new Date().toISOString()
            });
            throw error;
        }
    }

    async searchOrders(params = {}) {
        const searchParams = {
            fields: this.defaultFields,
            ...params
        };

        if (params.startDate || params.endDate) {
            this.validateDateRange(params.startDate, params.endDate);
            searchParams.created_at_min = params.startDate?.toISOString();
            searchParams.created_at_max = params.endDate?.toISOString();
        }

        return this.handleRequest('get', `/v1/${NUVEMSHOP_CONFIG.userId}/orders`, { params: searchParams });
    }

    // M√©todos de atualiza√ß√£o
    async updateOrderStatus(orderId, status, options = {}) {
        this.validateOrderId(orderId);
        if (!status || typeof status !== 'string') {
            throw new Error('Status inv√°lido');
        }

        const data = {
            status,
            ...options
        };

        return this.handleRequest('put', `${NUVEMSHOP_CONFIG.endpoint}/orders/${orderId}`, { data });
    }

    async updateShippingInfo(orderId, trackingNumber, carrier = null) {
        this.validateOrderId(orderId);
        if (!trackingNumber || typeof trackingNumber !== 'string') {
            throw new Error('N√∫mero de rastreio inv√°lido');
        }

        const data = {
            shipping_tracking_number: trackingNumber,
            ...(carrier && { shipping_carrier: carrier })
        };

        return this.handleRequest('put', `${NUVEMSHOP_CONFIG.endpoint}/orders/${orderId}`, { data });
    }

    async addOrderNote(orderId, note) {
        this.validateOrderId(orderId);
        if (!note || typeof note !== 'string') {
            throw new Error('Nota inv√°lida');
        }

        const data = { note };
        return this.handleRequest('put', `${NUVEMSHOP_CONFIG.endpoint}/orders/${orderId}`, { data });
    }

    // M√©todos de consulta espec√≠ficos
    async getRecentOrders(days = 7) {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        return this.searchOrders({
            startDate,
            endDate,
            sort: '-created_at'
        });
    }

    async getPendingOrders() {
        return this.searchOrders({
            status: ['pending', 'authorized', 'partially_paid'],
            sort: 'created_at'
        });
    }

    async getOrdersByCustomer(customerId) {
        if (!customerId) {
            throw new Error('ID do cliente inv√°lido');
        }

        return this.searchOrders({
            customer_id: customerId,
            sort: '-created_at'
        });
    }

    // M√©todos de formata√ß√£o
    formatOrderStatus(status) {
        const statusMap = {
            'pending': '‚è≥ Pendente',
            'authorized': '‚úÖ Autorizado',
            'partially_paid': 'üí∞ Parcialmente Pago',
            'paid': 'üí≥ Pago',
            'voided': '‚ùå Cancelado',
            'refunded': '‚Ü©Ô∏è Reembolsado',
            'shipped': 'üì¶ Enviado',
            'delivered': 'üè† Entregue'
        };
        return statusMap[status] || status;
    }

    formatShippingStatus(status) {
        const statusMap = {
            'pending': '‚è≥ Aguardando',
            'ready': 'üì¶ Pronto para Envio',
            'shipped': 'üöö Em Tr√¢nsito',
            'delivered': '‚úÖ Entregue',
            'returned': '‚Ü©Ô∏è Devolvido'
        };
        return statusMap[status] || status;
    }

    async getOrderByNumberNew(orderNumber) {
        try {
            const cacheKey = `order:${orderNumber}`;
            const cachedOrder = await this.cacheService.get(cacheKey);
            
            if (cachedOrder) {
                console.log('üì¶ Pedido encontrado em cache:', {
                    numero: orderNumber,
                    timestamp: new Date().toISOString()
                });
                return cachedOrder;
            }

            const response = await this.get(`${NUVEMSHOP_CONFIG.endpoint}/${orderNumber}`);
            if (response && response.data) {
                await this.cacheService.set(cacheKey, response.data, 3600); // Cache por 1 hora
                return response.data;
            }
            return null;
        } catch (error) {
            console.error('‚ùå Erro ao buscar pedido:', {
                numero: orderNumber,
                erro: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString()
            });
            return null;
        }
    }

    formatOrderStatusNew(status) {
        const statusMap = {
            'pending': '‚è≥ Aguardando pagamento',
            'paid': '‚úÖ Pago',
            'authorized': '‚úÖ Autorizado',
            'refunded': '‚Ü©Ô∏è Reembolsado',
            'voided': '‚ùå Cancelado',
            'failed': '‚ùå Falhou',
            'in_process': 'üè≠ Em processamento',
            'in_separation': 'üì¶ Em separa√ß√£o',
            'ready_for_shipping': 'üì¶ Pronto para envio',
            'shipped': 'üöö Enviado',
            'delivered': '‚úÖ Entregue',
            'canceled': '‚ùå Cancelado'
        };
        
        return statusMap[status] || `‚ùì ${status}`;
    }

    formatPrice(price) {
        if (!price) return 'R$ 0,00';
        
        const value = price / 100;
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    // M√©todos auxiliares
    calculateDeliveryEstimate(order) {
        if (!order.shipping_min_days || !order.shipping_max_days) {
            return null;
        }

        const shippedDate = order.shipped_at ? new Date(order.shipped_at) : new Date();
        const minDeliveryDate = new Date(shippedDate);
        const maxDeliveryDate = new Date(shippedDate);

        minDeliveryDate.setDate(minDeliveryDate.getDate() + order.shipping_min_days);
        maxDeliveryDate.setDate(maxDeliveryDate.getDate() + order.shipping_max_days);

        return {
            min: minDeliveryDate,
            max: maxDeliveryDate,
            formatted: `${minDeliveryDate.toLocaleDateString('pt-BR')} - ${maxDeliveryDate.toLocaleDateString('pt-BR')}`
        };
    }

    async handleRequest(method, endpoint, options = {}) {
        const requestConfig = {
            method,
            url: endpoint,
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Authentication': `bearer ${NUVEMSHOP_CONFIG.accessToken}`,
                'User-Agent': 'API Loja Ortopedic (suporte@lojaortopedic.com.br)',
                ...options.headers
            }
        };

        try {
            console.log('[Nuvemshop] Request:', {
                ...requestConfig,
                headers: {
                    ...requestConfig.headers,
                    Authentication: '[REDACTED]'
                }
            });

            const response = await this.client(requestConfig);
            return response.data;
        } catch (error) {
            // Log detalhado do erro
            console.log('[Nuvemshop] Erro na response:', {
                status: error.response?.status,
                data: error.response?.data,
                url: endpoint
            });

            // Trata erros espec√≠ficos
            if (error.response?.status === 401) {
                console.error('[Nuvemshop] Erro de autentica√ß√£o. Verifique o token de acesso.');
                throw new Error('Erro de autentica√ß√£o na API da Nuvemshop');
            }

            if (error.response?.status === 404) {
                return null;
            }

            // Propaga outros erros
            throw error;
        }
    }
}

module.exports = { OrderApi };
